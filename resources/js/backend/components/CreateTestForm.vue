<template>
    <form :action="action_url" method="POST" @submit.prevent="validateFields">
    <slot></slot>
    <div class="row" v-for="(question,index) in questions" :key="question.id">
        <input type="hidden" :ref="`question_${index}`" :value="question.id" :name="`questions[${index}][id]`">
        <div class="col-xl-12 col-sm-12 mb-3">
        <div class="card o-hidden h-100">
            <div class="card-header">
            <h5>
                <button type="button" @click="removeQuestion(index)" class="btn btn-danger pull-right"><i class="fa fa-times"></i></button>
                <button type="button" class="btn btn-link" data-toggle="collapse" :data-target="`#question_${index}`" aria-expanded="true"
                aria-controls="collapseOne">
                Question 1
                </button>
                
            </h5>
            </div>
            <div :id="`question_${index}`" class="collapse" aria-labelledby="headingOne" data-parent="">
            <!-- START CARD BODY -->
            <div class="card-body">


                <div class="form-group row">
                <label for="" class="col-sm-2 col-form-label">Question</label>
                <div class="col-sm-8">
                    <textarea rows="2" :class="[{'is-invalid' : question.valid != undefined  && !questions[index].text},'form-control']" v-model="questions[index].text" :name="`questions[${index}][text]`"></textarea>
                </div>
                </div>

                <div class="form-group row">
                <label for="" class="col-sm-2 col-form-label">Choices</label>
                <div class="col-sm-8">
                    <button class="btn btn-primary"  @click="addChoice(index)" type="button">Add Choices</button>
                </div>

                </div>

                <div class="form-group row" v-for="(choice,i) in question.choices" :key="choice.id">
                    
                    <input type="hidden" :value="questions[index].choices[i].id" :name="`questions[${index}][choices][${i}][id]`">
                <label for="" class="col-sm-2 col-form-label">
                    <button type="button" @click="removeChoice(index,i)" class="btn btn-danger"><i class="fa fa-times"></i></button>
                    A
                </label>

                <div class="col-sm-8">
                    <div class="input-group mb-3">
                    <textarea rows="2t" aria-label="Text input with checkbox" :class="[{'is-invalid' : questions[index].choices[i].valid != undefined && !questions[index].choices[i].text },'form-control']" v-model="questions[index].choices[i].text" :name="`questions[${index}][choices][${i}][text]`"></textarea>
                    <div class="input-group-append">
                        <div :class="[questions[index].choices[i].is_correct ? 'bg-success' : '','input-group-text']" @click="questions[index].choices[i].is_correct = !(questions[index].choices[i].is_correct)">
                        <input type="checkbox" :value="1" v-model="questions[index].choices[i].is_correct" id="" :name="`questions[${index}][choices][${i}][is_correct]`" >
                        </div>
                    </div>
                    </div>
                </div>

                </div>


                </div>

            </div>
            <!-- END CARD BODY -->


            </div>
        </div>
        </div>
        <button type="button" @click="addQuestion" class="btn btn-default">Add Question</button>
        <button type="submit" class="btn btn-default">Submit</button>
    </form>
</template>

<script>
    export default {
        props: {
            questions_data: {
                type: Array,
                default: () => []
            },
            action_url: String,
            csrf_field: String
        },
        data(){
            return {
                questions: this.questions_data
            }
        },
        methods: {
            addQuestion(){
                this.questions.push(
                    {
                        text:'',
                        choices: [
                            { text: '', is_correct: 1 },
                            { text: '', is_correct: 0 },
                        ]
                    }
                )
            },
            addChoice(question_index){
                this.questions[question_index].choices.push(
                    {
                        text: '',
                        is_correct: 0
                    }
                )
            },
            removeQuestion(index){
                this.questions.splice(index,1)
            },
            removeChoice(question_index,choice_index){
                this.questions[question_index].choices.splice(choice_index,1)
            },
            validateFields(e){
                let missing_fields = 0;
                this.questions = this.questions.map(q => {
                    if(q.text == ''){ q.valid = false; missing_fields++ }else{ delete q.valid }
                    let choices = q.choices.map(c => {
                        if(c.text == ''){ c.valid = false; missing_fields++ }else{ delete c.valid }
                        return c
                    })

                    q.choices = choices

                    return q;
                })

                if(!missing_fields){
                    e.target.submit();
                }

            }
        }
    }
</script>

<style scoped>
.correct {
    background: green;
}
.wrong{
    background: red;
}
input[type=checkbox]{
    width:35px;
    appearance: none;
}
</style>